meta_grammar_version: 1.2

# ============================================================
# DSL METADATA
# ============================================================
dsl:
  id: sxl-sql
  description: "S-expression language for expressing SQL SELECT queries"
  version: 2.0


# ============================================================
# SYMBOL DEFINITIONS
# ============================================================
symbols:

  # Top-level query
  Q:
    description: "Top-level SELECT query"
    kind: node
    params:
      - name: distinct
        description: "DISTINCT clause"
        type: node
        allowed_symbols: [D]
        cardinality: optional
        ordered: true
      
      - name: from
        description: "FROM clause"
        type: node
        allowed_symbols: [F]
        cardinality: optional
        ordered: true
      
      - name: joins
        description: "JOIN clauses (zero or more)"
        type: node
        allowed_symbols: [J, J_LEFT, J_RIGHT, J_FULL]
        cardinality: zeroOrMore
        ordered: true
      
      - name: select
        description: "SELECT clause (required)"
        type: node
        allowed_symbols: [S]
        cardinality: required
        ordered: true
      
      - name: where
        description: "WHERE clause"
        type: node
        allowed_symbols: [W]
        cardinality: optional
        ordered: true
      
      - name: groupBy
        description: "GROUP BY clause"
        type: node
        allowed_symbols: [G]
        cardinality: optional
        ordered: true
      
      - name: having
        description: "HAVING clause"
        type: node
        allowed_symbols: [H]
        cardinality: optional
        ordered: true
      
      - name: orderBy
        description: "ORDER BY clause"
        type: node
        allowed_symbols: [O]
        cardinality: optional
        ordered: true
      
      - name: limit
        description: "LIMIT clause"
        type: node
        allowed_symbols: [L]
        cardinality: optional
        ordered: true
    
    constraints:
      - rule: "must_have_root"
        symbol: "Q"
    
    examples:
      - label: "Simple SELECT"
        code: |
          (Q
            (F fact_sales f)
            (S
              (AS f.id     order_id)
              (AS f.amount total)
            )
          )
      
      - label: "Complex query with all clauses"
        code: |
          (Q
            (F fact_sales f)
            (J dim_customer c (EQ c.id f.customer_id))
            (S
              (AS c.name           customer)
              (AS (COUNT f.id)     orders)
              (AS (SUM f.amount)   total)
            )
            (W (EQ f.status "COMPLETED"))
            (G c.name)
            (H (GT (SUM f.amount) 5000))
            (O ((SUM f.amount) DESC))
            (L 10)
          )

  # DISTINCT clause
  D:
    description: "SELECT DISTINCT modifier"
    kind: node
    params: []
    
    examples:
      - label: "DISTINCT in query"
        code: |
          (Q
            (D)
            (F orders o)
            (S o.status)
          )

  # FROM clause
  F:
    description: "FROM clause specifying source table"
    kind: node
    params:
      - name: table_name
        description: "Table name"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
    
    examples:
      - label: "FROM clause"
        code: |
          (F orders o)

  # JOIN clauses
  J:
    description: "INNER JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "INNER JOIN"
        code: |
          (J products p (EQ o.product_id p.id))

  J_LEFT:
    description: "LEFT JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  J_RIGHT:
    description: "RIGHT JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  J_FULL:
    description: "FULL OUTER JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  # SELECT clause
  S:
    description: "SELECT clause with select items"
    kind: node
    params:
      - name: select_items
        description: "Select items (expressions or AS clauses)"
        type: node
        allowed_symbols: [AS]
        cardinality: oneOrMore
        ordered: true
    
    constraints:
      - rule: "order_requires"
        target: "S"
        depends_on: "F"
    
    examples:
      - label: "SELECT with aliases"
        code: |
          (S
            (AS c.name           customer)
            (AS (COUNT f.id)     orders)
            (AS (SUM f.amount)   total)
          )

  # AS clause (for aliasing expressions)
  AS:
    description: "Alias an expression in SELECT clause"
    kind: node
    params:
      - name: expr
        description: "Expression to alias (identifier, function call, or operator expression)"
        type: any
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Alias name"
        type: identifier
        cardinality: required
        ordered: true
    
    examples:
      - label: "Expression with alias"
        code: |
          (AS c.name customer)
          (AS (COUNT f.id) orders)

  # WHERE clause
  W:
    description: "WHERE clause with condition"
    kind: node
    params:
      - name: condition
        description: "Boolean expression for filtering rows"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "WHERE clause"
        code: |
          (W (GT p.price 100))
          (W (EQ f.status "COMPLETED"))

  # GROUP BY clause
  G:
    description: "GROUP BY clause"
    kind: node
    params:
      - name: expressions
        description: "Expressions to group by (identifiers or expressions)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "GROUP BY"
        code: |
          (G c.name c.region)

  # HAVING clause
  H:
    description: "HAVING clause with aggregate condition"
    kind: node
    params:
      - name: condition
        description: "Boolean expression (typically with aggregates)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "HAVING clause"
        code: |
          (H (GE (SUM f.amount) 5000))

  # ORDER BY clause
  O:
    description: "ORDER BY clause"
    kind: node
    params:
      - name: order_items
        description: "Order items (expressions, optionally with ASC/DESC)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "ORDER BY"
        code: |
          (O ((SUM f.amount) DESC))

  # LIMIT clause
  L:
    description: "LIMIT clause"
    kind: node
    params:
      - name: number
        description: "Number of rows to return"
        type: literal(number)
        cardinality: required
        ordered: true
    
    examples:
      - label: "LIMIT"
        code: |
          (L 10)

  # Comparison operators
  EQ:
    description: "Equal operator (=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Equality"
        code: |
          (EQ a b)
          (EQ f.status "COMPLETED")

  NE:
    description: "Not equal operator (!=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  LT:
    description: "Less than operator (<)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  GT:
    description: "Greater than operator (>)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Greater than"
        code: |
          (GT p.price 100)
          (GT x y)

  LE:
    description: "Less than or equal operator (<=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Less than or equal"
        code: |
          (LE amount 100)

  GE:
    description: "Greater than or equal operator (>=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Greater than or equal"
        code: |
          (GE (SUM f.amount) 5000)

  # Arithmetic operators
  ADD:
    description: "Addition operator (+)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Addition"
        code: |
          (ADD 2 3)

  SUB:
    description: "Subtraction operator (-)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  MUL:
    description: "Multiplication operator (*)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Multiplication"
        code: |
          (MUL price quantity)

  DIV:
    description: "Division operator (/)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  # Boolean operators
  AND:
    description: "Logical AND operator"
    kind: operator
    params:
      - name: conditions
        description: "Boolean conditions (one or more)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "AND operator"
        code: |
          (AND (GT x 10) (LT x 20))

  OR:
    description: "Logical OR operator"
    kind: operator
    params:
      - name: conditions
        description: "Boolean conditions (one or more)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: oneOrMore
        ordered: true

  NOT:
    description: "Logical NOT operator"
    kind: operator
    params:
      - name: condition
        description: "Boolean condition to negate"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  # Pattern matching operators
  LIKE:
    description: "LIKE pattern matching operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to match"
        type: any
        cardinality: required
        ordered: true
      
      - name: pattern
        description: "Pattern string"
        type: literal(string)
        cardinality: required
        ordered: true
    
    examples:
      - label: "LIKE operator"
        code: |
          (LIKE c.name "%Smith%")

  ILIKE:
    description: "Case-insensitive LIKE pattern matching operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to match"
        type: any
        cardinality: required
        ordered: true
      
      - name: pattern
        description: "Pattern string"
        type: literal(string)
        cardinality: required
        ordered: true

  # Range and membership operators
  BETWEEN:
    description: "BETWEEN operator (inclusive range)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: lower
        description: "Lower bound"
        type: any
        cardinality: required
        ordered: true
      
      - name: upper
        description: "Upper bound"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "BETWEEN operator"
        code: |
          (BETWEEN price 10 100)

  IN:
    description: "IN operator (membership test)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: options
        description: "List of options (one or more)"
        type: any
        cardinality: oneOrMore
        ordered: true

  NOT_IN:
    description: "NOT IN operator (negated membership test)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: options
        description: "List of options (one or more)"
        type: any
        cardinality: oneOrMore
        ordered: true

  # NULL check operators
  IS_NULL:
    description: "IS NULL operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to test for NULL"
        type: any
        cardinality: required
        ordered: true

  IS_NOT_NULL:
    description: "IS NOT NULL operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to test for NOT NULL"
        type: any
        cardinality: required
        ordered: true

  # Common SQL functions (examples - others can be added)
  COUNT:
    description: "COUNT aggregate function"
    kind: operator
    params:
      - name: expr
        description: "Expression to count (or empty for COUNT(*))"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "COUNT with expression"
        code: |
          (COUNT f.id)
      
      - label: "COUNT(*)"
        code: |
          (COUNT)

  SUM:
    description: "SUM aggregate function"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression to sum"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "SUM"
        code: |
          (SUM f.amount)

  UPPER:
    description: "UPPER function (convert to uppercase)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "UPPER"
        code: |
          (UPPER c.name)

  DATE_TRUNC:
    description: "DATE_TRUNC function (truncate date to unit)"
    kind: operator
    params:
      - name: unit
        description: "Time unit (e.g., 'month', 'year')"
        type: literal(string)
        cardinality: required
        ordered: true
      
      - name: expr
        description: "Date expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "DATE_TRUNC"
        code: |
          (DATE_TRUNC "month" f.order_date)

  EXTRACT:
    description: "EXTRACT function (extract part from date)"
    kind: operator
    params:
      - name: part
        description: "Part to extract (e.g., 'YEAR', 'MONTH')"
        type: literal(string)
        cardinality: required
        ordered: true
      
      - name: expr
        description: "Date expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "EXTRACT"
        code: |
          (EXTRACT "YEAR" o.created_at)

  # Special keywords for ORDER BY
  ASC:
    description: "ASC keyword for ORDER BY (ascending order)"
    kind: operator
    params: []

  DESC:
    description: "DESC keyword for ORDER BY (descending order)"
    kind: operator
    params: []


# ============================================================
# LITERAL DEFINITIONS
# ============================================================
literals:
  string:
    regex: "^\".*\"$"                      # DSL strings must use double quotes
  number:
    regex: "^-?[0-9]+(\\.[0-9]+)?$"
  boolean:
    values: [true, false]
  null:
    values: [null]


# ============================================================
# IDENTIFIER RULES
# ============================================================
identifier:
  description: "Default identifier rule for table names, aliases, column references"
  pattern: "^[A-Za-z_][A-Za-z0-9_\\.\\-]*$"


# ============================================================
# RESERVED SYMBOLS
# ============================================================
reserved_symbols:
  - AS


# ============================================================
# EMBEDDING RULES
# ============================================================
embedding:
  enabled: false  # SQL DSL does not support embedding other DSLs


# ============================================================
# DSL-WIDE CONSTRAINTS (GLOBAL RULES)
# ============================================================
constraints:
  - rule: "must_have_root"
    symbol: "Q"
  
  - rule: "order_requires"
    target: "S"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_LEFT"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_RIGHT"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_FULL"
    depends_on: "F"


# ============================================================
# LLM SPECIFICATION CONFIGURATION
# ============================================================
llm_specs:

  # ----------------------------------------------------------
  # DEFAULT CONFIGURATIONS for all providers/models
  # ----------------------------------------------------------
  defaults:
    style: strict
    max_examples: 3
    include_constraints: true
    include_symbol_summaries: true
    include_literal_rules: true
    include_identifier_rules: true
    formatting: block
    enforce_canonical_form: true
    preamble: true
    postamble: false

  # ----------------------------------------------------------
  # PROVIDER-LEVEL DEFAULTS
  # ----------------------------------------------------------
  provider_defaults:
    openai:
      style: strict
      max_examples: 2

    anthropic:
      style: explanatory
      max_examples: 5

    mistral:
      style: concise

    llama:
      style: strict

  # ----------------------------------------------------------
  # MODEL-SPECIFIC OVERRIDES
  # ----------------------------------------------------------
  models:
    openai:
      gpt-4.1:
        overrides:
          style: concise
          max_examples: 2

      gpt-5:
        overrides:
          max_examples: 4

    anthropic:
      claude-3:
        overrides:
          style: explanatory

    mistral:
      mistral-large:
        overrides:
          style: compact

  # ----------------------------------------------------------
  # OPTIONAL NAMED PROFILES
  # ----------------------------------------------------------
  profiles:
    testing:
      style: verbose
      include_constraints: true
      max_examples: 10

