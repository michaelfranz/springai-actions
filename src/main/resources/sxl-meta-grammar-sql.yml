meta_grammar_version: 1.2

# ============================================================
# DSL METADATA
# ============================================================
dsl:
  id: sxl-sql
  description: "S-expression language for expressing SQL SELECT queries"
  version: 2.0


# ============================================================
# SYMBOL DEFINITIONS
# ============================================================
symbols:

  # Top-level query
  Q:
    description: "Top-level SELECT query"
    kind: node
    params:
      - name: distinct
        description: "DISTINCT clause"
        type: node
        allowed_symbols: [D]
        cardinality: optional
        ordered: true
      
      - name: from
        description: "FROM clause"
        type: node
        allowed_symbols: [F]
        cardinality: optional
        ordered: true
      
      - name: joins
        description: "JOIN clauses (zero or more)"
        type: node
        allowed_symbols: [J, J_LEFT, J_RIGHT, J_FULL]
        cardinality: zeroOrMore
        ordered: true
      
      - name: select
        description: "SELECT clause (required)"
        type: node
        allowed_symbols: [S]
        cardinality: required
        ordered: true
      
      - name: where
        description: "WHERE clause"
        type: node
        allowed_symbols: [W]
        cardinality: optional
        ordered: true
      
      - name: groupBy
        description: "GROUP BY clause"
        type: node
        allowed_symbols: [G]
        cardinality: optional
        ordered: true
      
      - name: having
        description: "HAVING clause"
        type: node
        allowed_symbols: [H]
        cardinality: optional
        ordered: true
      
      - name: orderBy
        description: "ORDER BY clause"
        type: node
        allowed_symbols: [O]
        cardinality: optional
        ordered: true
      
      - name: limit
        description: "LIMIT clause"
        type: node
        allowed_symbols: [L]
        cardinality: optional
        ordered: true
    
    constraints:
      - rule: "must_have_root"
        symbol: "Q"
    
    examples:
      - label: "Simple SELECT"
        code: |
          (Q
            (F fact_sales f)
            (S
              (AS f.id     order_id)
              (AS f.amount total)
            )
          )
      
      - label: "Complex query with all clauses"
        code: |
          (Q
            (F fact_sales f)
            (J dim_customer c (EQ c.id f.customer_id))
            (S
              (AS c.name           customer)
              (AS (COUNT f.id)     orders)
              (AS (SUM f.amount)   total)
            )
            (W (EQ f.status "COMPLETED"))
            (G c.name)
            (H (GT (SUM f.amount) 5000))
            (O (DESC (SUM f.amount)))
            (L 10)
          )

  # DISTINCT clause
  D:
    description: "SELECT DISTINCT modifier"
    kind: node
    params: []
    
    examples:
      - label: "DISTINCT in query"
        code: |
          (Q
            (D)
            (F orders o)
            (S o.status)
          )

  # FROM clause
  F:
    description: "FROM clause specifying source table"
    kind: node
    params:
      - name: table_name
        description: "Table name"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
    
    examples:
      - label: "FROM clause"
        code: |
          (F orders o)

  # JOIN clauses
  J:
    description: "INNER JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "INNER JOIN"
        code: |
          (J products p (EQ o.product_id p.id))

  J_LEFT:
    description: "LEFT JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  J_RIGHT:
    description: "RIGHT JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  J_FULL:
    description: "FULL OUTER JOIN clause"
    kind: operator
    params:
      - name: table
        description: "Table name to join"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Table alias"
        type: identifier
        cardinality: required
        ordered: true
      
      - name: condition
        description: "Join condition (boolean expression)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  # SELECT clause
  S:
    description: "SELECT clause with select items"
    kind: node
    params:
      - name: select_items
        description: "Select items (expressions or AS clauses)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    constraints:
      - rule: "order_requires"
        target: "S"
        depends_on: "F"
    
    examples:
      - label: "SELECT with aliases"
        code: |
          (S
            (AS c.name           customer)
            (AS (COUNT f.id)     orders)
            (AS (SUM f.amount)   total)
          )

  # AS clause (for aliasing expressions)
  AS:
    description: "Alias an expression in SELECT clause"
    kind: node
    params:
      - name: expr
        description: "Expression to alias (identifier, function call, or operator expression)"
        type: any
        cardinality: required
        ordered: true
      
      - name: alias
        description: "Alias name"
        type: identifier
        cardinality: required
        ordered: true
    
    examples:
      - label: "Expression with alias"
        code: |
          (AS c.name customer)
          (AS (COUNT f.id) orders)

  # WHERE clause
  W:
    description: "WHERE clause with condition"
    kind: node
    params:
      - name: condition
        description: "Boolean expression for filtering rows"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "WHERE clause"
        code: |
          (W (GT p.price 100))
          (W (EQ f.status "COMPLETED"))

  # GROUP BY clause
  G:
    description: "GROUP BY clause"
    kind: node
    params:
      - name: expressions
        description: "Expressions to group by (identifiers or expressions)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "GROUP BY"
        code: |
          (G c.name c.region)

  # HAVING clause
  H:
    description: "HAVING clause with aggregate condition"
    kind: node
    params:
      - name: condition
        description: "Boolean expression (typically with aggregates)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true
    
    examples:
      - label: "HAVING clause"
        code: |
          (H (GE (SUM f.amount) 5000))

  # ORDER BY clause
  O:
    description: "ORDER BY clause"
    kind: node
    params:
      - name: order_items
        description: "Order items (expressions, optionally with ASC/DESC)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "ORDER BY with simple column"
        code: |
          (O (DESC o.amount))
      - label: "ORDER BY with function"
        code: |
          (O (DESC (SUM f.amount)))

  # LIMIT clause
  L:
    description: "LIMIT clause"
    kind: node
    params:
      - name: number
        description: "Number of rows to return"
        type: literal(number)
        cardinality: required
        ordered: true
    
    examples:
      - label: "LIMIT"
        code: |
          (L 10)

  # Comparison operators
  EQ:
    description: "Equal operator (=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Equality"
        code: |
          (EQ a b)
          (EQ f.status "COMPLETED")

  NE:
    description: "Not equal operator (!=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  LT:
    description: "Less than operator (<)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  GT:
    description: "Greater than operator (>)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Greater than"
        code: |
          (GT p.price 100)
          (GT x y)

  LE:
    description: "Less than or equal operator (<=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Less than or equal"
        code: |
          (LE amount 100)

  GE:
    description: "Greater than or equal operator (>=)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Greater than or equal"
        code: |
          (GE (SUM f.amount) 5000)

  # Arithmetic operators
  ADD:
    description: "Addition operator (+)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Addition"
        code: |
          (ADD 2 3)

  SUB:
    description: "Subtraction operator (-)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  MUL:
    description: "Multiplication operator (*)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "Multiplication"
        code: |
          (MUL price quantity)

  DIV:
    description: "Division operator (/)"
    kind: operator
    params:
      - name: left
        description: "Left operand"
        type: any
        cardinality: required
        ordered: true
      
      - name: right
        description: "Right operand"
        type: any
        cardinality: required
        ordered: true

  # Boolean operators
  AND:
    description: "Logical AND operator"
    kind: operator
    params:
      - name: conditions
        description: "Boolean conditions (one or more)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "AND operator"
        code: |
          (AND (GT x 10) (LT x 20))

  OR:
    description: "Logical OR operator"
    kind: operator
    params:
      - name: conditions
        description: "Boolean conditions (one or more)"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: oneOrMore
        ordered: true

  NOT:
    description: "Logical NOT operator"
    kind: operator
    params:
      - name: condition
        description: "Boolean condition to negate"
        type: node
        allowed_symbols: [EQ, NE, LT, GT, LE, GE, AND, OR, NOT, LIKE, ILIKE, BETWEEN, IN, NOT_IN, IS_NULL, IS_NOT_NULL]
        cardinality: required
        ordered: true

  # Pattern matching operators
  LIKE:
    description: "LIKE pattern matching operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to match"
        type: any
        cardinality: required
        ordered: true
      
      - name: pattern
        description: "Pattern string"
        type: literal(string)
        cardinality: required
        ordered: true
    
    examples:
      - label: "LIKE operator"
        code: |
          (LIKE c.name "%Smith%")

  ILIKE:
    description: "Case-insensitive LIKE pattern matching operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to match"
        type: any
        cardinality: required
        ordered: true
      
      - name: pattern
        description: "Pattern string"
        type: literal(string)
        cardinality: required
        ordered: true

  # Range and membership operators
  BETWEEN:
    description: "BETWEEN operator (inclusive range)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: lower
        description: "Lower bound"
        type: any
        cardinality: required
        ordered: true
      
      - name: upper
        description: "Upper bound"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "BETWEEN operator"
        code: |
          (BETWEEN price 10 100)

  IN:
    description: "IN operator (membership test)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: options
        description: "List of options (one or more)"
        type: any
        cardinality: oneOrMore
        ordered: true

  NOT_IN:
    description: "NOT IN operator (negated membership test)"
    kind: operator
    params:
      - name: value
        description: "Value to test"
        type: any
        cardinality: required
        ordered: true
      
      - name: options
        description: "List of options (one or more)"
        type: any
        cardinality: oneOrMore
        ordered: true

  # NULL check operators
  IS_NULL:
    description: "IS NULL operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to test for NULL"
        type: any
        cardinality: required
        ordered: true

  IS_NOT_NULL:
    description: "IS NOT NULL operator"
    kind: operator
    params:
      - name: expr
        description: "Expression to test for NOT NULL"
        type: any
        cardinality: required
        ordered: true

  # Common SQL functions (examples - others can be added)
  COUNT:
    description: "COUNT aggregate function"
    kind: operator
    params:
      - name: expr
        description: "Expression to count (or empty for COUNT(*))"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "COUNT with expression"
        code: |
          (COUNT f.id)
      
      - label: "COUNT(*)"
        code: |
          (COUNT)

  SUM:
    description: "SUM aggregate function"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression to sum"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "SUM"
        code: |
          (SUM f.amount)

  AVG:
    description: "AVG aggregate function (average)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression to average"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "AVG"
        code: |
          (AVG f.amount)

  MIN:
    description: "MIN aggregate function (minimum)"
    kind: operator
    params:
      - name: expr
        description: "Expression to find minimum value"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "MIN"
        code: |
          (MIN f.amount)

  MAX:
    description: "MAX aggregate function (maximum)"
    kind: operator
    params:
      - name: expr
        description: "Expression to find maximum value"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "MAX"
        code: |
          (MAX f.amount)

  UPPER:
    description: "UPPER function (convert to uppercase)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "UPPER"
        code: |
          (UPPER c.name)

  LOWER:
    description: "LOWER function (convert to lowercase)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "LOWER"
        code: |
          (LOWER c.name)

  LENGTH:
    description: "LENGTH function (get string length)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "LENGTH"
        code: |
          (LENGTH c.email)

  CONCAT:
    description: "CONCAT function (concatenate string values)"
    kind: operator
    params:
      - name: expressions
        description: "String expressions to concatenate (two or more)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "CONCAT multiple columns"
        code: |
          (CONCAT c.first_name " " c.last_name)

  SUBSTR:
    description: "SUBSTR function (extract substring from string)"
    kind: operator
    params:
      - name: expr
        description: "String expression to extract from"
        type: any
        cardinality: required
        ordered: true
      
      - name: start_position
        description: "Starting position (1-based index)"
        type: any
        cardinality: required
        ordered: true
      
      - name: length
        description: "Length of substring to extract (optional)"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "SUBSTR with start position only"
        code: |
          (SUBSTR c.email 1)
      - label: "SUBSTR with start position and length"
        code: |
          (SUBSTR c.email 1 5)

  TRIM:
    description: "TRIM function (remove leading/trailing whitespace)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true

  LTRIM:
    description: "LTRIM function (remove leading whitespace)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true

  RTRIM:
    description: "RTRIM function (remove trailing whitespace)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true

  REPLACE:
    description: "REPLACE function (replace substring)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: from_str
        description: "Substring to find"
        type: any
        cardinality: required
        ordered: true
      
      - name: to_str
        description: "Replacement string"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "REPLACE"
        code: |
          (REPLACE c.email "@old.com" "@new.com")

  LPAD:
    description: "LPAD function (left pad string)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: length
        description: "Target length"
        type: any
        cardinality: required
        ordered: true
      
      - name: pad_str
        description: "Padding string (optional, default space)"
        type: any
        cardinality: optional
        ordered: true

  RPAD:
    description: "RPAD function (right pad string)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: length
        description: "Target length"
        type: any
        cardinality: required
        ordered: true
      
      - name: pad_str
        description: "Padding string (optional, default space)"
        type: any
        cardinality: optional
        ordered: true

  INSTR:
    description: "INSTR function (find substring position)"
    kind: operator
    params:
      - name: str
        description: "String to search in"
        type: any
        cardinality: required
        ordered: true
      
      - name: substr
        description: "Substring to find"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "INSTR"
        code: |
          (INSTR c.email "@")

  ABS:
    description: "ABS function (absolute value)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "ABS"
        code: |
          (ABS (SUB o.expected_amount o.actual_amount))

  ROUND:
    description: "ROUND function (round numeric value)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: decimals
        description: "Number of decimal places (optional)"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "ROUND with decimals"
        code: |
          (ROUND o.amount 2)

  CEIL:
    description: "CEIL function (round up)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression"
        type: any
        cardinality: required
        ordered: true

  FLOOR:
    description: "FLOOR function (round down)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression"
        type: any
        cardinality: required
        ordered: true

  POWER:
    description: "POWER function (exponentiation)"
    kind: operator
    params:
      - name: base
        description: "Base number"
        type: any
        cardinality: required
        ordered: true
      
      - name: exponent
        description: "Exponent"
        type: any
        cardinality: required
        ordered: true

  SQRT:
    description: "SQRT function (square root)"
    kind: operator
    params:
      - name: expr
        description: "Numeric expression"
        type: any
        cardinality: required
        ordered: true

  MOD:
    description: "MOD function (modulo operator)"
    kind: operator
    params:
      - name: expr
        description: "Dividend"
        type: any
        cardinality: required
        ordered: true
      
      - name: divisor
        description: "Divisor"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "MOD"
        code: |
          (MOD o.id 3)

  CURRENT_DATE:
    description: "CURRENT_DATE function (get current date)"
    kind: operator
    params: []
    
    examples:
      - label: "CURRENT_DATE"
        code: |
          (CURRENT_DATE)

  CURRENT_TIMESTAMP:
    description: "CURRENT_TIMESTAMP function (get current timestamp)"
    kind: operator
    params: []
    
    examples:
      - label: "CURRENT_TIMESTAMP"
        code: |
          (CURRENT_TIMESTAMP)

  COALESCE:
    description: "COALESCE function (return first non-null value)"
    kind: operator
    params:
      - name: expressions
        description: "Expressions to evaluate (one or more)"
        type: any
        cardinality: oneOrMore
        ordered: true
    
    examples:
      - label: "COALESCE"
        code: |
          (COALESCE c.phone_work c.phone_home c.phone_mobile)

  NULLIF:
    description: "NULLIF function (return NULL if values equal)"
    kind: operator
    params:
      - name: expr1
        description: "First expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: expr2
        description: "Second expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "NULLIF"
        code: |
          (NULLIF o.discount 0)

  NVL:
    description: "NVL function (NULL value replacement)"
    kind: operator
    params:
      - name: expr
        description: "Expression to check"
        type: any
        cardinality: required
        ordered: true
      
      - name: replacement
        description: "Replacement value if NULL"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "NVL"
        code: |
          (NVL c.phone "No phone")

  TO_DATE:
    description: "TO_DATE function (convert string to date)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: format
        description: "Date format (optional)"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "TO_DATE with format"
        code: |
          (TO_DATE "2024-01-15" "YYYY-MM-DD")

  TO_NUMBER:
    description: "TO_NUMBER function (convert string to number)"
    kind: operator
    params:
      - name: expr
        description: "String expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: format
        description: "Number format (optional)"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "TO_NUMBER"
        code: |
          (TO_NUMBER "12345.67")

  DATE_ADD:
    description: "DATE_ADD function (add interval to date)"
    kind: operator
    params:
      - name: date_expr
        description: "Date expression"
        type: any
        cardinality: required
        ordered: true
      
      - name: interval
        description: "Interval (e.g., '1 DAY', '2 MONTH')"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "DATE_ADD"
        code: |
          (DATE_ADD o.order_date "1 MONTH")

  DATE_DIFF:
    description: "DATE_DIFF function (difference between dates)"
    kind: operator
    params:
      - name: date1
        description: "First date"
        type: any
        cardinality: required
        ordered: true
      
      - name: date2
        description: "Second date"
        type: any
        cardinality: required
        ordered: true
      
      - name: unit
        description: "Unit (e.g., 'DAY', 'MONTH')"
        type: any
        cardinality: optional
        ordered: true
    
    examples:
      - label: "DATE_DIFF"
        code: |
          (DATE_DIFF o.shipped_date o.order_date)

  DATE_TRUNC:
    description: "DATE_TRUNC function (truncate date to unit)"
    kind: operator
    params:
      - name: unit
        description: "Time unit (e.g., 'month', 'year')"
        type: literal(string)
        cardinality: required
        ordered: true
      
      - name: expr
        description: "Date expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "DATE_TRUNC"
        code: |
          (DATE_TRUNC "month" f.order_date)

  EXTRACT:
    description: "EXTRACT function (extract part from date)"
    kind: operator
    params:
      - name: part
        description: "Part to extract (e.g., 'YEAR', 'MONTH')"
        type: literal(string)
        cardinality: required
        ordered: true
      
      - name: expr
        description: "Date expression"
        type: any
        cardinality: required
        ordered: true
    
    examples:
      - label: "EXTRACT"
        code: |
          (EXTRACT "YEAR" o.created_at)

  # Special keywords for ORDER BY
  ASC:
    description: "ASC keyword for ORDER BY (ascending order)"
    kind: operator
    params:
      - name: expr
        description: "Expression to sort by in ascending order"
        type: any
        cardinality: required
        ordered: true

  DESC:
    description: "DESC keyword for ORDER BY (descending order)"
    kind: operator
    params:
      - name: expr
        description: "Expression to sort by in descending order"
        type: any
        cardinality: required
        ordered: true


# ============================================================
# LITERAL DEFINITIONS
# ============================================================
literals:
  string:
    regex: "^\".*\"$"                      # DSL strings must use double quotes
  number:
    regex: "^-?[0-9]+(\\.[0-9]+)?$"
  boolean:
    values: [true, false]
  null:
    values: [null]


# ============================================================
# IDENTIFIER RULES
# ============================================================
identifier:
  description: "Default identifier rule for table names, aliases, column references"
  pattern: "^[A-Za-z_][A-Za-z0-9_\\.\\-]*$"


# ============================================================
# RESERVED SYMBOLS
# ============================================================
reserved_symbols:
  - AS


# ============================================================
# EMBEDDING RULES
# ============================================================
embedding:
  enabled: false  # SQL DSL does not support embedding other DSLs


# ============================================================
# DSL-WIDE CONSTRAINTS (GLOBAL RULES)
# ============================================================
constraints:
  - rule: "must_have_root"
    symbol: "Q"
  
  - rule: "order_requires"
    target: "S"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_LEFT"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_RIGHT"
    depends_on: "F"
  
  - rule: "order_requires"
    target: "J_FULL"
    depends_on: "F"


# ============================================================
# LLM SPECIFICATION CONFIGURATION
# ============================================================
llm_specs:

  # ----------------------------------------------------------
  # DEFAULT CONFIGURATIONS for all providers/models
  # ----------------------------------------------------------
  defaults:
    style: strict
    max_examples: 3
    include_constraints: true
    include_symbol_summaries: true
    include_literal_rules: true
    include_identifier_rules: true
    formatting: block
    enforce_canonical_form: true
    preamble: true
    postamble: false

  # ----------------------------------------------------------
  # PROVIDER-LEVEL DEFAULTS
  # ----------------------------------------------------------
  provider_defaults:
    openai:
      style: strict
      max_examples: 2

    anthropic:
      style: explanatory
      max_examples: 5

    mistral:
      style: concise

    llama:
      style: strict

  # ----------------------------------------------------------
  # MODEL-SPECIFIC OVERRIDES
  # ----------------------------------------------------------
  models:
    openai:
      gpt-4.1:
        overrides:
          style: concise
          max_examples: 2

      gpt-5:
        overrides:
          max_examples: 4

    anthropic:
      claude-3:
        overrides:
          style: explanatory

    mistral:
      mistral-large:
        overrides:
          style: compact

  # ----------------------------------------------------------
  # OPTIONAL NAMED PROFILES
  # ----------------------------------------------------------
  profiles:
    testing:
      style: verbose
      include_constraints: true
      max_examples: 10

