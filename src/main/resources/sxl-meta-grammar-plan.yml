meta_grammar_version: 1.2

# ============================================================
# DSL METADATA
# ============================================================
dsl:
  id: sxl-plan
  description: "S-expression language for expressing execution plans with steps"
  version: 2.0


# ============================================================
# SYMBOL DEFINITIONS
# ============================================================
symbols:

  # Top-level plan
  P:
    description: "Top level plan node"
    kind: node
    params:
      - name: description
        description: "A description of how the plan steps address the overall goal of the plan"
        type: literal(string)
        cardinality: optional
        ordered: true
      
      - name: steps
        description: "List of steps in the plan (one or more)"
        type: node
        allowed_symbols: [PS, ERROR]
        cardinality: zeroOrMore
        ordered: true
      
    examples:
      - label: "Simple PLAN"
        code: |
          (EMBED sxl-plan
            (P "Find all orders with status COMPLETED"
              (PS queryCompletedOrders (EMBED sxl-sql (Q (F fact_sales f) (W (EQ f.status "COMPLETED")) (S (AS f.id order_id)))))
              (PS getOrderStatuses (EMBED sxl-sql (Q (F orders o) (S (AS o.status order_status)))))
            )
          )
  PS:
    description: "Single step in a plan"
    kind: node
    params:
      - name: action-id
        description: "The id of the action to execute for this step"
        type: identifier
        cardinality: required
        ordered: true
        identifier_rules:
          pattern: "^[a-z][a-zA-Z0-9_$]*$"

      - name: step-items
        description: "Zero or more parameters/embeds"
        type: node
        allowed_symbols: [PA, PENDING, EMBED]
        cardinality: zeroOrMore
        ordered: true

  PA:
    description: "Plan parameter"
    kind: node
    params:
      - name: name
        description: "Parameter name"
        type: identifier
        cardinality: required
        ordered: true
      - name: value
        description: "Parameter value(s); repeat the literal value to represent list/array parameters"
        type: literal(string)
        cardinality: oneOrMore
        ordered: true

  PENDING:
    description: "Pending plan parameter that must be supplied/clarified before execution"
    kind: node
    params:
      - name: name
        description: "Parameter name that is missing/invalid/unclear"
        type: identifier
        cardinality: required
        ordered: true
      - name: message
        description: "Assistant message explaining what is needed (e.g., missing value, invalid input, clarification)"
        type: literal(string)
        cardinality: required
        ordered: true

  ERROR:
    description: "Represents an error step - when an LLM failed to generate a valid expression for this step"
    kind: node
    params:
      - name: reason
        description: "User-friendly and/or technical message explaining why the step failed"
        type: literal(string)
        cardinality: required
        ordered: true

      - name: fallback
        description: "Optional fallback expression to use when the step fails"
        type: node
        allowed_symbols: [EMBED]
        cardinality: optional
        ordered: true

    examples:
      - label: "Simple error with reason only"
        code: |
          (ERROR "LLM timeout after 30 seconds")

      - label: "Error with fallback expression"
        code: |
          (ERROR "Failed to generate complex join" (EMBED sxl-sql (Q (F orders o) (S (AS o.id id)))))

  # Examples illustrating allowed PS shapes (parameters, embeds)
  PS-examples:
    examples:
      - label: "Step with no parameters"
        code: |
          (EMBED sxl-plan
            (P
              (PS displayControlChart)
            )
          )
      - label: "Step with one parameter"
        code: |
          (EMBED sxl-plan
            (P
              (PS displayControlChart
                (PA bundleId "A12345")
              )
            )
          )
      - label: "Step with multiple parameters"
        code: |
          (EMBED sxl-plan
            (P
              (PS displayControlChart
                (PA domainEntity "elasticity bundle")
                (PA measurementConcept "displacement")
                (PA bundleId "A12345")
              )
            )
          )
      - label: "Step with mixed parameters and EMBED"
        code: |
          (EMBED sxl-plan
            (P
              (PS displayControlChart
                (EMBED sxl-sql (Q (F fact_sales f) (S (AS f.disp displacement))))
                (PA bundleId "A12345")
              )
            )
          )
      - label: "Step with list/array parameter"
        code: |
          (EMBED sxl-plan
            (P
              (PS someActionNeedingManyIds
                (PA bundleIds "A12345" "A3145" "B4323")
              )
            )
          )

  # Error step example at plan level
  ERROR-examples:
    examples:
      - label: "Plan-level error step"
        code: |
          (EMBED sxl-plan
            (P "Plan with error"
              (ERROR "Missing bundleId")
            )
          )

# ============================================================
# LITERAL DEFINITIONS
# ============================================================
literals:
  string:
    regex: "^\".*\"$"                      # DSL strings must use double quotes
  number:
    regex: "^-?[0-9]+(\\.[0-9]+)?$"
  boolean:
    values: [true, false]
  null:
    values: [null]


# ============================================================
# IDENTIFIER RULES
# ============================================================
identifier:
  description: "Default identifier rule for table names, aliases, column references"
  pattern: "^[A-Za-z_][A-Za-z0-9_\\.\\-]*$"


# ============================================================
# RESERVED SYMBOLS
# ============================================================
reserved_symbols:
  - AS


# ============================================================
# EMBEDDING RULES
# ============================================================
embedding:
  enabled: true  # PLAN DSL support embeddings other DSLs
  symbol: EMBED
  auto_register_symbol: true


# ============================================================
# DSL-WIDE CONSTRAINTS (GLOBAL RULES)
# ============================================================
constraints:
  - rule: "must_have_root"
    symbol: "P"


# ============================================================
# LLM SPECIFICATION CONFIGURATION
# ============================================================
llm_specs:

  # ----------------------------------------------------------
  # DEFAULT CONFIGURATIONS for all providers/models
  # ----------------------------------------------------------
  defaults:
    style: strict
    max_examples: 6
    include_constraints: true
    include_symbol_summaries: true
    include_literal_rules: true
    include_identifier_rules: true
    formatting: block
    enforce_canonical_form: true
    preamble: true
    postamble: false
    guidance: |
      PLAN DSL root: (P ["description"] (PS action-id <step-items>)...).
      step-items: zero or more parameter/EMBED/PENDING nodes. Parameters use the PA symbol: (PA name "value"). For list/array parameters, repeat literal values inside the same PA: (PA bundleIds "A12345" "A3145" "B4323"). Pending items use (PENDING name "what is needed") when a required/invalid/unclear value is missing; do not emit empty strings. Embeds use (EMBED <dsl-id> <payload>).
      Errors are separate steps at plan level: (ERROR "..."). Do NOT put ERROR inside PS. Do NOT invent wrapper nodes. Always include the DSL id in EMBED.
      If required params are missing/invalid/unclear, emit inline PENDING entries instead of guessing or leaving empty values. Example: (P "Export control chart" (PS exportControlChartToExcel (PENDING bundleId "Provide bundle id") (PA domainEntity "displacement") (PA measurementConcept "values"))).

  # ----------------------------------------------------------
  # PROVIDER-LEVEL DEFAULTS
  # ----------------------------------------------------------
  provider_defaults:
    openai:
      style: strict
      max_examples: 2
      guidance: |
        PLAN DSL: Root is (P ["description"] steps...). Each step: (PS action-id <step-items>).
        step-items: zero or more parameter/EMBED/PENDING nodes. Parameters use (PA name "value"); for list/array parameters repeat literal values in the same PA: (PA bundleIds "A12345" "A3145" "B4323"); embeds use (EMBED <dsl-id> <payload>); missing/invalid/unclear required params use (PENDING name "what is needed")—never emit empty strings.
        Errors are separate steps: (ERROR "..."). Return exactly one sxl-plan rooted at (P …); only PS or ERROR steps; action-id must come from the catalog; if params are missing, prefer inline PENDING over inventing values; no other symbols.

    anthropic:
      style: explanatory
      max_examples: 5

    mistral:
      style: concise

    llama:
      style: strict

  # ----------------------------------------------------------
  # MODEL-SPECIFIC OVERRIDES
  # ----------------------------------------------------------
  models:
    openai:
      gpt-4.1:
        overrides:
          style: concise
          max_examples: 2

      gpt-5:
        overrides:
          max_examples: 4

    anthropic:
      claude-3:
        overrides:
          style: explanatory

    mistral:
      mistral-large:
        overrides:
          style: compact

  # ----------------------------------------------------------
  # OPTIONAL NAMED PROFILES
  # ----------------------------------------------------------
  profiles:
    testing:
      style: verbose
      include_constraints: true
      max_examples: 10

