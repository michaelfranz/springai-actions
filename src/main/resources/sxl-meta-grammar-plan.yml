meta_grammar_version: 1.2

# ============================================================
# DSL METADATA
# ============================================================
dsl:
  id: sxl-plan
  description: "S-expression language for expressing execution plans with steps"
  version: 2.0


# ============================================================
# SYMBOL DEFINITIONS
# ============================================================
symbols:

  # Top-level plan
  P:
    description: "Top level plan node"
    kind: node
    params:
      - name: description
        description: "A description of how the plan steps address the overall goal of the plan"
        type: literal(string)
        cardinality: optional
        ordered: true
      
      - name: steps
        description: "List of steps in the plan (one or more)"
        type: node
        allowed_symbols: [PS, ES]
        cardinality: zeroOrMore
        ordered: true
      
    examples:
      - label: "Simple PLAN"
        code: |
          (EMBED sxl-plan
            (P "Find all orders with status COMPLETED"
              (PS queryCompletedOrders (EMBED sxl-sql (Q (F fact_sales f) (W (EQ f.status "COMPLETED")) (S (AS f.id order_id)))))
              (PS getOrderStatuses (EMBED sxl-sql (Q (F orders o) (S (AS o.status order_status)))))
            )
          )
  PS:
    description: "Single step in a plan"
    kind: node
    params:
      - name: action-id
        description: "The id of the action to execute for this step"
        type: identifier
        cardinality: required
        ordered: true
        identifier_rules:
          pattern: "^[a-z][a-zA-Z0-9_$]*$"

      - name: step-content
        description: "Either an embedded DSL expression or an error step describing why this step failed"
        type: node
        allowed_symbols: [EMBED, ERROR]
        cardinality: required
        ordered: true

  ERROR:
    description: "Represents an error step - when an LLM failed to generate a valid expression for this step"
    kind: node
    params:
      - name: reason
        description: "User-friendly and/or technical message explaining why the step failed"
        type: literal(string)
        cardinality: required
        ordered: true

      - name: fallback
        description: "Optional fallback expression to use when the step fails"
        type: node
        allowed_symbols: [EMBED]
        cardinality: optional
        ordered: true

    examples:
      - label: "Simple error with reason only"
        code: |
          (ERROR "LLM timeout after 30 seconds")

      - label: "Error with fallback expression"
        code: |
          (ERROR "Failed to generate complex join" (EMBED sxl-sql (Q (F orders o) (S (AS o.id id)))))

# ============================================================
# LITERAL DEFINITIONS
# ============================================================
literals:
  string:
    regex: "^\".*\"$"                      # DSL strings must use double quotes
  number:
    regex: "^-?[0-9]+(\\.[0-9]+)?$"
  boolean:
    values: [true, false]
  null:
    values: [null]


# ============================================================
# IDENTIFIER RULES
# ============================================================
identifier:
  description: "Default identifier rule for table names, aliases, column references"
  pattern: "^[A-Za-z_][A-Za-z0-9_\\.\\-]*$"


# ============================================================
# RESERVED SYMBOLS
# ============================================================
reserved_symbols:
  - AS


# ============================================================
# EMBEDDING RULES
# ============================================================
embedding:
  enabled: true  # PLAN DSL support embeddings other DSLs
  symbol: EMBED
  auto_register_symbol: true


# ============================================================
# DSL-WIDE CONSTRAINTS (GLOBAL RULES)
# ============================================================
constraints:
  - rule: "must_have_root"
    symbol: "P"


# ============================================================
# LLM SPECIFICATION CONFIGURATION
# ============================================================
llm_specs:

  # ----------------------------------------------------------
  # DEFAULT CONFIGURATIONS for all providers/models
  # ----------------------------------------------------------
  defaults:
    style: strict
    max_examples: 3
    include_constraints: true
    include_symbol_summaries: true
    include_literal_rules: true
    include_identifier_rules: true
    formatting: block
    enforce_canonical_form: true
    preamble: true
    postamble: false
    guidance: |
      You are given a PLAN DSL with root symbol P (plan) and steps PS, and error nodes ERROR. Each plan has a description and zero or more steps. Each step has a human-friendly message, an action id, and either an EMBED of another DSL payload or an ERROR reason. Always emit well-formed S-expressions matching the grammar, respect ordering, and include DSL ids when embedding (e.g., (EMBED sxl-sql ...)). Do not invent symbols outside the grammar. Prefer concise, canonical forms.

  # ----------------------------------------------------------
  # PROVIDER-LEVEL DEFAULTS
  # ----------------------------------------------------------
  provider_defaults:
    openai:
      style: strict
      max_examples: 2
      guidance: |
        Use concise, canonical S-expressions for the PLAN DSL. Root must be (P <description> ...steps...). Each step is (PS <assistant-message> <action-id> <content>) where <content> is either (EMBED <dsl-id> <payload>) or (ERROR "reason"). Always include DSL ids on EMBED nodes (e.g., sxl-sql). Do not add extra text outside the S-expression. Keep descriptions short, avoid markdown, and favor minimal whitespace.

    anthropic:
      style: explanatory
      max_examples: 5

    mistral:
      style: concise

    llama:
      style: strict

  # ----------------------------------------------------------
  # MODEL-SPECIFIC OVERRIDES
  # ----------------------------------------------------------
  models:
    openai:
      gpt-4.1:
        overrides:
          style: concise
          max_examples: 2

      gpt-5:
        overrides:
          max_examples: 4

    anthropic:
      claude-3:
        overrides:
          style: explanatory

    mistral:
      mistral-large:
        overrides:
          style: compact

  # ----------------------------------------------------------
  # OPTIONAL NAMED PROFILES
  # ----------------------------------------------------------
  profiles:
    testing:
      style: verbose
      include_constraints: true
      max_examples: 10

