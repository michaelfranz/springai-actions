meta_grammar_version: 1.2

# ============================================================
# DSL METADATA
# ============================================================
dsl:
  id: string                  # Unique DSL identifier (e.g. "sxl-sql")
  description: string         # Human-readable description
  version: string             # DSL version (e.g. "2.0")


# ============================================================
# SYMBOL DEFINITIONS
# ============================================================
symbols:
  <symbol-name>:
    description: string

    # node     = normal DSL symbol forming an s-expression
    # operator = designated operator symbol (optional classification)
    # special  = symbols with nonstandard semantics (e.g., EMBED)
    # literal  = symbol representing a literal wrapper (rare)
    kind: node

    params:
      - name: string
        description: string

        # The parameter type:
        #
        # node                = another symbol (must list allowed_symbols)
        # literal(X)          = literal of type X, where X âˆˆ {string, number, boolean, null}
        # literal(A|B)        = union (e.g., literal(string|number))
        # identifier          = plain identifier / dotted identifier
        # dsl-id              = name of an inner DSL (for embedding)
        # embedded            = subtree validated by another DSL
        # any                 = no restrictions
        #
        type: string

        # Only applies when type: node
        allowed_symbols:
          - <symbol1>
          - <symbol2>

        # Cardinality of parameter occurrences:
        # required | optional | zeroOrMore | oneOrMore
        cardinality: required

        # Whether repeated arguments must appear in a fixed order (default true)
        ordered: true

        # Optional: a regex for identifiers (if type = identifier)
        identifier_rules:
          pattern: string


    # ========================================================
    # Symbol-level constraints using the formal constraint DSL.
    # Each entry is a structured rule, not free text.
    # ========================================================
    constraints:
      - rule: string             # e.g., "requires", "must_have_root", "disallowed_together"
        target: string           # e.g., "GROUP_BY" (rule-dependent)
        symbol: string           # for must_have_root or similar
        items: [string, ...]     # list for disallowed_together
        when: string             # predicate expression (optional)


    # ========================================================
    # Examples for documentation and LLM prompt generation
    # ========================================================
    examples:
      - label: string
        code: |
          (EXAMPLE ...)
          


# ============================================================
# LITERAL DEFINITIONS
# ============================================================
literals:
  string:
    regex: "^\".*\"$"                      # DSL strings must use double quotes
  number:
    regex: "^-?[0-9]+(\\.[0-9]+)?$"
  boolean:
    values: [true, false]
  null:
    values: [null]


# ============================================================
# IDENTIFIER RULES
# ============================================================
identifier:
  description: "Default identifier rule"
  pattern: "^[A-Za-z_][A-Za-z0-9_\\.\\-]*$"


# ============================================================
# RESERVED SYMBOLS
# ============================================================
reserved_symbols:
  - EMBED
  - AS


# ============================================================
# EMBEDDING RULES
# ============================================================
embedding:
  enabled: true
  symbol: EMBED
  auto_register_symbol: true

  params:
    - name: dsl_id
      type: dsl-id
      cardinality: required

    - name: payload
      type: embedded
      cardinality: required


# ============================================================
# DSL-WIDE CONSTRAINTS (GLOBAL RULES)
# ============================================================
constraints:
  # Example global constraints:
  - rule: "must_have_root"
    symbol: "Q"

  - rule: "order_requires"
    target: "JOIN"
    depends_on: "F"


# ============================================================
# LLM SPECIFICATION CONFIGURATION
# ============================================================
llm_specs:

  # ----------------------------------------------------------
  # DEFAULT CONFIGURATIONS for all providers/models
  # ----------------------------------------------------------
  defaults:
    style: strict                     # strict | concise | verbose | explanatory
    max_examples: 3
    include_constraints: true
    include_symbol_summaries: true
    include_literal_rules: true
    include_identifier_rules: true
    formatting: block                 # block | compact | markdown
    enforce_canonical_form: true
    preamble: true
    postamble: false


  # ----------------------------------------------------------
  # PROVIDER-LEVEL DEFAULTS (OpenAI, Anthropic, Mistral, etc.)
  # ----------------------------------------------------------
  provider_defaults:
    openai:
      style: strict
      max_examples: 2

    anthropic:
      style: explanatory
      max_examples: 5

    mistral:
      style: concise

    llama:
      style: strict


  # ----------------------------------------------------------
  # MODEL-SPECIFIC OVERRIDES
  #
  # Overrides modify defaults + provider defaults.
  # Only fields that differ need to be specified.
  # ----------------------------------------------------------
  models:

    openai:
      gpt-4.1:
        overrides:
          style: concise
          max_examples: 2

      gpt-5:
        overrides:
          max_examples: 4

    anthropic:
      claude-3:
        overrides:
          style: explanatory

    mistral:
      mistral-large:
        overrides:
          style: compact


  # ----------------------------------------------------------
  # OPTIONAL NAMED PROFILES (for testing, debugging, fine-tuning)
  # ----------------------------------------------------------
  profiles:
    testing:
      style: verbose
      include_constraints: true
      max_examples: 10